#!/usr/bin/env python3.7

import argparse
import json  # orjson does not have an option to pretty-serialize (indent=2)
import os
import sys
import yaml

from coco import Endpoint, result

# result printing styles:
STYLES = ["json", "yaml"]


def str2bool(v):
    if v.lower() in ('yes', 'true', 't', 'y', '1'):
        return True
    elif v.lower() in ('no', 'false', 'f', 'n', '0'):
        return False
    else:
        raise argparse.ArgumentTypeError('Boolean value expected.')


def read_config(config_path):
    with open(config_path, "r") as stream:
        try:
            config = yaml.safe_load(stream)
        except yaml.YAMLError as exc:
            print("coco-client: Failure reading YAML file {}: {}".format(config_path, exc))
            exit(1)
    try:
        endpoint_dir = config["endpoint_dir"]
    except KeyError:
        print("coco-client: Could not find value for 'endpoint_dir' in YAML file '{}'"
              .format(config_path))
        exit(1)
    try:
        host = config["host"]
    except KeyError:
        print("coco-client: Could not find value for 'host' in YAML file '{}'".format(config_path))
        exit(1)
    try:
        port = config["port"]
    except KeyError:
        print("coco-client: Could not find value for 'port' in YAML file '{}'".format(config_path))
        exit(1)
    return endpoint_dir, host, port


def load_endpoints(endpoint_path):
    ee = dict()
    for endpoint_file in sorted(os.listdir(endpoint_path)):
        # Only accept files ending in .conf as endpoint configs.
        # Endpoint config files starting with an underscore (_) are disabled.
        if endpoint_file.endswith(".conf") and not endpoint_file.startswith("_"):

            # Remove .conf from the config file name to get the name of the endpoint
            name = os.path.splitext(endpoint_file)[0]

            with open(os.path.join(endpoint_path, endpoint_file), "r") as stream:
                try:
                    conf = yaml.safe_load(stream)
                except yaml.YAMLError as exc:
                    print("coco-client: Failure reading YAML file {}: {}"
                          .format(endpoint_file, exc))
            conf["state"] = None
            ee[name] = Endpoint(name, conf, None, None, None)
    return ee


# The default coco.conf path.
# The default here should be suitable for running coco
# without installing it. An installed coco should always
# specify the location of its configuration file
# on the command line.
coco_conf = os.path.normpath(os.path.join(sys.path[0], "../conf/coco.conf"))

parser = argparse.ArgumentParser(
        description="This is the coco-client.",
        epilog="""\
If no configuration file is specified via -c, coco-client will use {0} which should be suitable for
running coco-client without first installing it.
""".format(coco_conf)
        )

# Find the endpoints before using argparse
try:
    if '-c' in sys.argv:
        conf = sys.argv[sys.argv.index('-c') + 1]
    elif '--conf' in sys.argv:
        conf = sys.argv[sys.argv.index('--conf') + 1]
    else:
        conf = coco_conf
except IndexError:
    conf = coco_conf

# Find endpoint path in config
endpoint_path, host, port = read_config(conf)
endpoints = load_endpoints(endpoint_path)

# Global options
parser.add_argument(
        "-c", "--conf",
        metavar="PATH",
        help="read coco.conf file specified by PATH",
        default=coco_conf
        )
parser.add_argument(
        "-r", "--report",
        metavar="TYPE",
        help="specify report type (choose from {})".format(result.TYPES),
        default="CODES_OVERVIEW",
        choices=result.TYPES
        )
parser.add_argument(
        "-s", "--style",
        metavar="STYLE",
        help="specify print style (choose from {})".format(STYLES),
        default="yaml",
        choices=STYLES
        )

subparsers = parser.add_subparsers(
        title="endpoint",
        metavar="ENDPOINT",
        help=''
        "The endpoint to call. For endpoint-specific help, use: `ENDPOINT -h'")

# Build endpoint parsers
for name, endpoint in endpoints.items():
    endpoint_parser = subparsers.add_parser(name, help=f"{endpoint.description} ({endpoint.type}).")
    if endpoint.values:
        for v, t in endpoint.values.items():
            # argparse can't handle dicts, lists and listsoflists like we want...
            # Parse them as JSON str and decode it in `Endpoint.client_call`.
            if t == list or t == dict:
                endpoint_parser.add_argument(v, type=str, help=t.__name__.upper())
            elif t == bool:
                endpoint_parser.add_argument(v, type=str2bool, help=t.__name__.upper())
            else:
                endpoint_parser.add_argument(v, type=t, help=t.__name__.upper())
    endpoint_parser.set_defaults(func=endpoint.client_call, endpoint=endpoint)

parsed_args = parser.parse_args()

if hasattr(parsed_args, "func"):
    result = parsed_args.func(host, port, parsed_args)
    if parsed_args.style == "json":
        print(json.dumps(result, indent=2))
    elif parsed_args.style == "yaml":
        print(yaml.dump(result))
    else:
        print("Unknown print style: {} (Choose from {})".format(parsed_args.style, STYLES))
else:
    parser.print_help()
    print("\ncoco: error: an endpoint must be specified")
    exit(1)

exit(0)
